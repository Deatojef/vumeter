class VUMeter{static VERSION="1.0.0";static DEFAULTS={width:300,height:200,dbMin:-20,dbMax:3,noiseFloor:-20,ballistics:!0,attackTime:300,releaseTime:300,label:"VU",brand:"MODEL 300",showLight:!0,onClip:null,onClipRelease:null,clipThreshold:0,autoRange:!1,autoRangeWindow:30,autoRangeMargin:2,showPeak:!1,peakColor:"#5599ff",peakAttackTime:50,peakHoldTime:2e3,peakDecayTime:1500,scalePreset:null};static SMETER_TICKS=[{db:-121,label:"S1"},{db:-115,label:"S2"},{db:-109,label:"S3"},{db:-103,label:"S4"},{db:-97,label:"S5"},{db:-91,label:"S6"},{db:-85,label:"S7"},{db:-79,label:"S8"},{db:-73,label:"S9"},{db:-63,label:"+10"},{db:-53,label:"+20"},{db:-33,label:"+40"},{db:-13,label:"+60"}];static CX=150;static CY=175;static ARC_R=140;static TIP_LEN=152;static TAIL_LEN=28;static SWEEP=100;static ANGLE_MIN=220;constructor(t,i={}){this._container=t,this._options=Object.assign({},VUMeter.DEFAULTS,i),this._uid="vu"+Math.random().toString(36).slice(2,7),this._initDbMin=this._options.dbMin,this._initDbMax=this._options.dbMax,this._targetDb=this._options.dbMin,this._currentDb=this._options.dbMin,this._clipping=!1,this._paused=!1,this._rafId=null,this._lastTime=null,this._rangeSamples=[],this._autoRangeTargetMin=this._options.dbMin,this._autoRangeTargetMax=this._options.dbMax,this._lastRebuiltDbMin=this._options.dbMin,this._lastRebuiltDbMax=this._options.dbMax,this._peakDb=this._options.dbMin,this._peakVisualDb=this._options.dbMin,this._peakHoldUntil=0,this._peakDecaying=!1,this._onVisibility=()=>{document.hidden?this.pause():this.resume()},this._build(),this._startAnimation(),document.addEventListener("visibilitychange",this._onVisibility)}setValue(t){const i=this._options;if(i.autoRange){const e=Date.now(),s=e-1e3*i.autoRangeWindow;if(this._rangeSamples.push({db:t,t:e}),this._rangeSamples=this._rangeSamples.filter(t=>t.t>=s),this._rangeSamples.length>0){const t=this._rangeSamples.map(t=>t.db),e=Math.min(...t),s=Math.max(...t),o=e-i.autoRangeMargin,a=s+i.autoRangeMargin;this._autoRangeTargetMin=o,this._autoRangeTargetMax=a;let n=i.dbMin,l=i.dbMax,h=!1;o<i.dbMin&&(n=o,h=!0),a>i.dbMax&&(l=a,h=!0),h&&this.setRange(n,l)}}const{dbMin:e,dbMax:s,noiseFloor:o}=i;let a;a=t<=o?e:e+(t-o)/(s-o)*(s-e),this._targetDb=Math.max(e,Math.min(s+1,a))}setAmplitude(t){t<=0?this.setValue(-1/0):this.setValue(20*Math.log10(t))}getValue(){return this._currentDb}setRange(t,i){this._options.dbMin=t,this._options.dbMax=i,this._targetDb=Math.max(t,Math.min(i,this._targetDb)),this._currentDb=Math.max(t,Math.min(i,this._currentDb)),this._rebuildScale(),this._lastRebuiltDbMin=t,this._lastRebuiltDbMax=i}resetRange(){this._rangeSamples=[],this._autoRangeTargetMin=this._initDbMin,this._autoRangeTargetMax=this._initDbMax,this._options.dbMin=this._initDbMin,this._options.dbMax=this._initDbMax,this._rebuildScale(),this._lastRebuiltDbMin=this._initDbMin,this._lastRebuiltDbMax=this._initDbMax}setOptions(t){const i="clipThreshold"in t||"scalePreset"in t||"label"in t||"brand"in t;Object.assign(this._options,t),i&&this._rebuildScale()}pause(){null!==this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=null),this._paused=!0}resume(){this._paused&&(this._paused=!1,this._lastTime=null,this._rafId=requestAnimationFrame(t=>this._animate(t)))}destroy(){this.pause(),document.removeEventListener("visibilitychange",this._onVisibility),this._svg&&this._svg.parentNode&&this._svg.parentNode.removeChild(this._svg),this._svg=null}_build(){const{width:t,height:i}=this._options,e="http://www.w3.org/2000/svg",s=document.createElementNS(e,"svg");s.setAttribute("viewBox","0 0 300 200"),s.setAttribute("xmlns",e),t&&s.setAttribute("width",t),i&&s.setAttribute("height",i),s.setAttribute("aria-label","VU Meter"),s.setAttribute("role","img"),this._svg=s,this._ns=e;const o=document.createElement("div");o.className="vu-meter",o.appendChild(s),this._wrapper=o,this._container.appendChild(o),this._buildDefs(),this._buildHousing(),this._buildFace(),this._scaleGroup=document.createElementNS(e,"g"),this._scaleGroup.setAttribute("id","vu-scale-"+this._uid),this._svg.appendChild(this._scaleGroup),this._buildScale(),this._buildBranding(),this._buildNeedle(),this._buildPivot(),this._buildBezel(),this._buildLight(),this._buildGlass()}_el(t,i={}){const e=document.createElementNS(this._ns,t);for(const[t,s]of Object.entries(i))e.setAttribute(t,s);return this._svg.appendChild(e),e}_elIn(t,i,e={}){const s=document.createElementNS(this._ns,i);for(const[t,i]of Object.entries(e))s.setAttribute(t,i);return t.appendChild(s),s}_rebuildScale(){for(;this._scaleGroup.firstChild;)this._scaleGroup.removeChild(this._scaleGroup.firstChild);this._buildScale(),this._buildBranding()}_buildDefs(){const t=this._uid,i=document.createElementNS(this._ns,"defs");this._svg.appendChild(i);const e=this._elIn(i,"linearGradient",{id:t+"-glass",x1:"0",y1:"0",x2:"0",y2:"1",gradientUnits:"objectBoundingBox"});this._elIn(e,"stop",{offset:"0%","stop-color":"white","stop-opacity":"0.18"}),this._elIn(e,"stop",{offset:"45%","stop-color":"white","stop-opacity":"0.04"}),this._elIn(e,"stop",{offset:"100%","stop-color":"black","stop-opacity":"0.07"});const s=this._elIn(i,"radialGradient",{id:t+"-jewel-off",cx:"40%",cy:"35%",r:"60%"});this._elIn(s,"stop",{offset:"0%","stop-color":"#7a3800","stop-opacity":"1"}),this._elIn(s,"stop",{offset:"100%","stop-color":"#2a1000","stop-opacity":"1"});const o=this._elIn(i,"radialGradient",{id:t+"-jewel-on",cx:"40%",cy:"35%",r:"60%"});this._elIn(o,"stop",{offset:"0%","stop-color":"#ff8060","stop-opacity":"1"}),this._elIn(o,"stop",{offset:"60%","stop-color":"#dd2200","stop-opacity":"1"}),this._elIn(o,"stop",{offset:"100%","stop-color":"#880000","stop-opacity":"1"});const a=this._elIn(i,"linearGradient",{id:t+"-housing",x1:"0",y1:"0",x2:"0",y2:"1"});this._elIn(a,"stop",{offset:"0%","stop-color":"#383838"}),this._elIn(a,"stop",{offset:"100%","stop-color":"#1a1a1a"});const n=this._elIn(i,"radialGradient",{id:t+"-face",cx:"50%",cy:"40%",r:"65%",gradientUnits:"objectBoundingBox"});this._elIn(n,"stop",{offset:"0%","stop-color":"#faf4de"}),this._elIn(n,"stop",{offset:"100%","stop-color":"#e8dfc0"})}_buildHousing(){this._el("rect",{x:"0",y:"0",width:"300",height:"200",rx:"12",ry:"12",fill:`url(#${this._uid}-housing)`})}_buildFace(){this._el("rect",{x:"8",y:"8",width:"284",height:"155",rx:"5",ry:"5",fill:`url(#${this._uid}-face)`}),this._el("rect",{x:"8",y:"8",width:"284",height:"155",rx:"5",ry:"5",fill:"none",stroke:"#b0a070","stroke-width":"0.8",opacity:"0.6"})}_dbToAngleDeg(t){const{dbMin:i,dbMax:e}=this._options;return VUMeter.ANGLE_MIN+(t-i)/(e-i)*VUMeter.SWEEP}_angleToXY(t,i){const e=t*Math.PI/180;return{x:VUMeter.CX+i*Math.cos(e),y:VUMeter.CY+i*Math.sin(e)}}_arcPath(t,i,e){const s=this._dbToAngleDeg(t)*Math.PI/180,o=this._dbToAngleDeg(i)*Math.PI/180;return`M ${(VUMeter.CX+e*Math.cos(s)).toFixed(3)} ${(VUMeter.CY+e*Math.sin(s)).toFixed(3)} A ${e} ${e} 0 0 1 ${(VUMeter.CX+e*Math.cos(o)).toFixed(3)} ${(VUMeter.CY+e*Math.sin(o)).toFixed(3)}`}_buildScale(){const{dbMin:t,dbMax:i,clipThreshold:e,scalePreset:s}=this._options,o=VUMeter.ARC_R,a=Math.max(t,Math.min(i,e));a>t&&this._elIn(this._scaleGroup,"path",{d:this._arcPath(t,a,o),fill:"none",stroke:"#1a1a1a","stroke-width":"1.5","stroke-linecap":"round"}),a<i&&this._elIn(this._scaleGroup,"path",{d:this._arcPath(a,i,o),fill:"none",stroke:"#cc2200","stroke-width":"2","stroke-linecap":"round"}),"smeter"===s?this._buildSmeterScale():this._buildDefaultScale()}_buildDefaultScale(){const{dbMin:t,dbMax:i,clipThreshold:e}=this._options,s=VUMeter.ARC_R,o=[-20,-10,-7,-5,-3,-2,-1,0,1,2,3].filter(e=>e>=t&&e<=i),a=new Set(o);for(let o=Math.ceil(t);o<=i;o++){const t=a.has(o),i=o>e,n=this._dbToAngleDeg(o),l=t?s-25:s-15,h=this._angleToXY(n,s),r=this._angleToXY(n,l);this._elIn(this._scaleGroup,"line",{x1:h.x.toFixed(3),y1:h.y.toFixed(3),x2:r.x.toFixed(3),y2:r.y.toFixed(3),stroke:i?"#cc2200":"#1a1a1a","stroke-width":t?"1.4":"0.8","stroke-linecap":"round"})}const n=s-35;for(const t of o){const i=this._dbToAngleDeg(t),s=this._angleToXY(i,n),o=t>e,a=t>0?`+${t}`:`${t}`;this._elIn(this._scaleGroup,"text",{x:s.x.toFixed(3),y:s.y.toFixed(3),"text-anchor":"middle","dominant-baseline":"middle","font-size":-20===t||-10===t?"7.5":"8.5","font-family":"Georgia, Times New Roman, serif",fill:o?"#cc2200":"#1a1a1a","font-weight":0===t?"bold":"normal"}).textContent=a}}_buildSmeterScale(){const{dbMin:t,dbMax:i,clipThreshold:e}=this._options,s=VUMeter.ARC_R,o=s-35,a=VUMeter.SMETER_TICKS.filter(e=>e.db>=t&&e.db<=i),n=new Set(a.map(t=>t.db));for(let o=t;o<=i;o+=6){if(n.has(o))continue;const t=o>e,i=this._dbToAngleDeg(o),a=this._angleToXY(i,s),l=this._angleToXY(i,s-15);this._elIn(this._scaleGroup,"line",{x1:a.x.toFixed(3),y1:a.y.toFixed(3),x2:l.x.toFixed(3),y2:l.y.toFixed(3),stroke:t?"#cc2200":"#1a1a1a","stroke-width":"0.8","stroke-linecap":"round"})}for(const{db:t,label:i}of a){const a=t>e,n=this._dbToAngleDeg(t),l=this._angleToXY(n,s),h=this._angleToXY(n,s-25),r=this._angleToXY(n,o);this._elIn(this._scaleGroup,"line",{x1:l.x.toFixed(3),y1:l.y.toFixed(3),x2:h.x.toFixed(3),y2:h.y.toFixed(3),stroke:a?"#cc2200":"#1a1a1a","stroke-width":"1.4","stroke-linecap":"round"});const _=i.startsWith("+");this._elIn(this._scaleGroup,"text",{x:r.x.toFixed(3),y:r.y.toFixed(3),"text-anchor":"middle","dominant-baseline":"middle","font-size":_?"7":"8","font-family":"Georgia, Times New Roman, serif",fill:a?"#cc2200":"#1a1a1a","font-weight":"S9"===i?"bold":"normal"}).textContent=i}}_buildBranding(){const{label:t,brand:i}=this._options;if(t){this._elIn(this._scaleGroup,"text",{x:"150",y:"108","text-anchor":"middle","dominant-baseline":"middle","font-size":"20","font-family":"Georgia, Times New Roman, serif","font-weight":"bold",fill:"#1a1a1a","letter-spacing":"5"}).textContent=t}if(i){this._elIn(this._scaleGroup,"text",{x:"150",y:"120","text-anchor":"middle","dominant-baseline":"middle","font-size":"6.5","font-family":"Arial, Helvetica, sans-serif",fill:"#666666","letter-spacing":"2"}).textContent=i.toUpperCase()}}_buildNeedle(){const t=this._dbToAngleDeg(this._options.dbMin),i=this._angleToXY(t,VUMeter.TIP_LEN),e=this._angleToXY(t+180,VUMeter.TAIL_LEN);if(this._needle=this._el("line",{x1:e.x.toFixed(3),y1:e.y.toFixed(3),x2:i.x.toFixed(3),y2:i.y.toFixed(3),stroke:"#111111","stroke-width":"1.2","stroke-linecap":"round"}),this._counterweight=this._el("ellipse",{cx:e.x.toFixed(3),cy:e.y.toFixed(3),rx:"3.5",ry:"2.2",fill:"#333333"}),this._counterweight.setAttribute("transform",`rotate(${t}, ${e.x.toFixed(3)}, ${e.y.toFixed(3)})`),this._options.showPeak){const s=this._options.peakColor;this._peakNeedle=this._el("line",{x1:e.x.toFixed(3),y1:e.y.toFixed(3),x2:i.x.toFixed(3),y2:i.y.toFixed(3),stroke:s,"stroke-width":"1.0","stroke-linecap":"round"}),this._peakCounterweight=this._el("ellipse",{cx:e.x.toFixed(3),cy:e.y.toFixed(3),rx:"3.5",ry:"2.2",fill:s}),this._peakCounterweight.setAttribute("transform",`rotate(${t}, ${e.x.toFixed(3)}, ${e.y.toFixed(3)})`)}}_buildPivot(){this._el("circle",{cx:VUMeter.CX,cy:VUMeter.CY,r:"5",fill:"#999999",stroke:"#555555","stroke-width":"0.6"}),this._el("circle",{cx:VUMeter.CX,cy:VUMeter.CY,r:"1.8",fill:"#2a2a2a"})}_buildBezel(){this._el("rect",{x:"6",y:"6",width:"288",height:"158",rx:"7",ry:"7",fill:"none",stroke:"#999999","stroke-width":"1.2",opacity:"0.7"}),this._el("rect",{x:"7",y:"7",width:"286",height:"156",rx:"6.5",ry:"6.5",fill:"none",stroke:"#cccccc","stroke-width":"0.4",opacity:"0.35"})}_buildLight(){if(!this._options.showLight)return;this._el("ellipse",{cx:"262",cy:"28",rx:"11",ry:"7",fill:"#1a1a1a",stroke:"#555","stroke-width":"0.8"}),this._light=this._el("ellipse",{cx:"262",cy:"28",rx:"8.5",ry:"5.5",fill:`url(#${this._uid}-jewel-off)`}),this._el("ellipse",{cx:"259",cy:"26",rx:"2.5",ry:"1.5",fill:"white",opacity:"0.25","pointer-events":"none"});this._el("text",{x:"262",y:"39","text-anchor":"middle","dominant-baseline":"middle","font-size":"5","font-family":"Arial, Helvetica, sans-serif",fill:"#888888","letter-spacing":"0.5"}).textContent="CLIP"}_buildGlass(){this._el("rect",{x:"8",y:"8",width:"284",height:"155",rx:"5",ry:"5",fill:`url(#${this._uid}-glass)`,"pointer-events":"none"})}_startAnimation(){this._paused=!1,this._rafId=requestAnimationFrame(t=>this._animate(t))}_animate(t){null===this._lastTime&&(this._lastTime=t);const i=Math.min(t-this._lastTime,100);if(this._lastTime=t,this._options.autoRange){const t=i/1e3;this._options.dbMin,this._options.dbMax;this._options.dbMin<this._autoRangeTargetMin&&(this._options.dbMin=Math.min(this._options.dbMin+t,this._autoRangeTargetMin)),this._options.dbMax>this._autoRangeTargetMax&&(this._options.dbMax=Math.max(this._options.dbMax-t,this._autoRangeTargetMax)),(Math.abs(this._options.dbMin-this._lastRebuiltDbMin)>=1||Math.abs(this._options.dbMax-this._lastRebuiltDbMax)>=1)&&(this._rebuildScale(),this._lastRebuiltDbMin=this._options.dbMin,this._lastRebuiltDbMax=this._options.dbMax)}if(this._options.ballistics){const t=this._targetDb-this._currentDb;if(Math.abs(t)<.005)this._currentDb=this._targetDb;else{const e=t>0?this._options.attackTime:this._options.releaseTime,s=1-Math.exp(-i/e);this._currentDb+=t*s}}else this._currentDb=this._targetDb;const{dbMin:e,dbMax:s}=this._options;if(this._currentDb=Math.max(e,Math.min(s+.5,this._currentDb)),this._updateNeedle(this._currentDb),this._updateClipState(this._currentDb),this._options.showPeak&&this._peakNeedle){const t=Date.now();if(this._targetDb>this._peakDb&&(this._peakDb=this._targetDb,this._peakHoldUntil=t+this._options.peakHoldTime,this._peakDecaying=!1),!this._peakDecaying&&this._peakHoldUntil>0&&t>=this._peakHoldUntil&&(this._peakDecaying=!0),this._peakDecaying){const t=1-Math.exp(-i/this._options.peakDecayTime);this._peakVisualDb+=(e-this._peakVisualDb)*t,this._peakVisualDb<=e+.05&&(this._peakDb=e,this._peakVisualDb=e,this._peakDecaying=!1,this._peakHoldUntil=0)}else{const t=1-Math.exp(-i/this._options.peakAttackTime);this._peakVisualDb+=(this._peakDb-this._peakVisualDb)*t}this._updatePeakNeedle(this._peakVisualDb)}this._rafId=requestAnimationFrame(t=>this._animate(t))}_updateNeedle(t){const i=this._dbToAngleDeg(t),e=this._angleToXY(i,VUMeter.TIP_LEN),s=i+180,o=this._angleToXY(s,VUMeter.TAIL_LEN);this._needle.setAttribute("x1",o.x.toFixed(2)),this._needle.setAttribute("y1",o.y.toFixed(2)),this._needle.setAttribute("x2",e.x.toFixed(2)),this._needle.setAttribute("y2",e.y.toFixed(2)),this._counterweight.setAttribute("cx",o.x.toFixed(2)),this._counterweight.setAttribute("cy",o.y.toFixed(2)),this._counterweight.setAttribute("transform",`rotate(${i.toFixed(2)}, ${o.x.toFixed(2)}, ${o.y.toFixed(2)})`)}_updatePeakNeedle(t){const i=this._dbToAngleDeg(t),e=this._angleToXY(i,VUMeter.TIP_LEN),s=i+180,o=this._angleToXY(s,VUMeter.TAIL_LEN);this._peakNeedle.setAttribute("x1",o.x.toFixed(2)),this._peakNeedle.setAttribute("y1",o.y.toFixed(2)),this._peakNeedle.setAttribute("x2",e.x.toFixed(2)),this._peakNeedle.setAttribute("y2",e.y.toFixed(2)),this._peakCounterweight.setAttribute("cx",o.x.toFixed(2)),this._peakCounterweight.setAttribute("cy",o.y.toFixed(2)),this._peakCounterweight.setAttribute("transform",`rotate(${i.toFixed(2)}, ${o.x.toFixed(2)}, ${o.y.toFixed(2)})`)}_updateClipState(t){const i=t>this._options.clipThreshold;i!==this._clipping&&(this._clipping=i,this._light&&this._light.setAttribute("fill",i?`url(#${this._uid}-jewel-on)`:`url(#${this._uid}-jewel-off)`),this._wrapper&&(i?this._wrapper.classList.add("vu-meter--clipping"):this._wrapper.classList.remove("vu-meter--clipping")),i&&"function"==typeof this._options.onClip&&this._options.onClip(),i||"function"!=typeof this._options.onClipRelease||this._options.onClipRelease())}}