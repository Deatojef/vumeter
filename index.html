<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VUMeter — Vintage Analog VU Meter</title>
    <link rel="stylesheet" href="src/vumeter.css">
    <link rel="stylesheet" href="demo.css">
</head>
<body>

    <h1>VU Meter</h1>

    <!-- Three VU meter instances -->
    <div class="meter-row">
        <div class="meter-wrap">
            <div id="meter-left"></div>
            <span class="meter-label">Ch. L</span>
        </div>
        <div class="meter-wrap">
            <div id="meter-right"></div>
            <span class="meter-label">Ch. R</span>
        </div>
        <div class="meter-wrap">
            <div id="meter-master"></div>
            <span class="meter-label">Master</span>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls">

        <!-- Manual level slider -->
        <div class="control-group" id="manual-group">
            <label>Manual Level</label>
            <div class="slider-row">
                <span class="db-readout" style="min-width:40px; text-align:left;">−20</span>
                <input type="range" id="db-slider" min="-20" max="3" step="0.1" value="-20">
                <span class="db-readout" id="db-readout">−20.0 dB</span>
            </div>
        </div>

        <!-- Mode buttons -->
        <div class="btn-row">
            <button id="btn-manual" class="active">Manual</button>
            <button id="btn-sim">Simulated Audio</button>
            <button id="btn-mic">Microphone</button>
        </div>

        <p class="hint" id="hint-text">Drag the slider to set the level on all three meters.</p>

    </div>

    <!-- S-meter section -->
    <h2 style="margin-top:2em;">S-Meter (ham radio / SDR)</h2>
    <div class="meter-row">
        <div class="meter-wrap">
            <div id="meter-smeter"></div>
            <span class="meter-label">Signal Strength</span>
        </div>
    </div>

    <div class="controls">
        <div class="control-group">
            <label>Signal Level (dBm)</label>
            <div class="slider-row">
                <span class="db-readout" style="min-width:40px; text-align:left;">−121</span>
                <input type="range" id="sm-slider" min="-121" max="-13" step="0.5" value="-100">
                <span class="db-readout" id="sm-readout">−100.0 dBm</span>
            </div>
        </div>
        <div class="btn-row">
            <button id="btn-sm-manual" class="active">Manual</button>
            <button id="btn-sm-sim">Simulated SDR</button>
        </div>
        <p class="hint" id="sm-hint">Drag the slider to set the signal level. Clip threshold is S9+20 (−53 dBm).</p>
    </div>

    <script src="src/vumeter.js"></script>
    <script>
    (function () {

        // ─── Create meter instances ──────────────────────────────────────────

        const meterL = new VUMeter(document.getElementById('meter-left'), {
            label: 'VU',
            brand: 'CH. L',
            showLight: true,
        });

        const meterR = new VUMeter(document.getElementById('meter-right'), {
            label: 'VU',
            brand: 'CH. R',
            showLight: true,
        });

        const meterM = new VUMeter(document.getElementById('meter-master'), {
            label: 'VU',
            brand: 'MASTER',
            showLight: true,
            onClip: function () {
                document.getElementById('hint-text').textContent = 'Clipping! Signal above 0 VU.';
                document.getElementById('hint-text').style.color = '#cc4400';
            },
            onClipRelease: function () {
                restoreHint();
            },
        });

        const allMeters = [meterL, meterR, meterM];

        // ─── Slider (manual mode) ────────────────────────────────────────────

        const slider   = document.getElementById('db-slider');
        const readout  = document.getElementById('db-readout');

        function formatDb(v) {
            const sign = v >= 0 ? '+' : '';
            return sign + v.toFixed(1) + ' dB';
        }

        slider.addEventListener('input', function () {
            const db = parseFloat(this.value);
            readout.textContent = formatDb(db);
            allMeters.forEach(m => m.setValue(db));
        });

        // ─── Mode management ─────────────────────────────────────────────────

        let mode      = 'manual';   // 'manual' | 'sim' | 'mic'
        let simTimer  = null;
        let simLevel  = -12;
        let audioCtx  = null;
        let analyser  = null;
        let micStream = null;
        let micRafId  = null;

        const btnManual = document.getElementById('btn-manual');
        const btnSim    = document.getElementById('btn-sim');
        const btnMic    = document.getElementById('btn-mic');
        const hintEl    = document.getElementById('hint-text');
        const manualGrp = document.getElementById('manual-group');

        function setMode(newMode) {
            // Tear down previous mode
            if (mode === 'sim' && simTimer !== null) {
                clearInterval(simTimer);
                simTimer = null;
            }
            if (mode === 'mic') {
                stopMic();
            }

            mode = newMode;

            btnManual.classList.toggle('active', mode === 'manual');
            btnSim.classList.toggle('active',    mode === 'sim');
            btnMic.classList.toggle('active',    mode === 'mic');

            manualGrp.style.opacity    = mode === 'manual' ? '1' : '0.35';
            manualGrp.style.pointerEvents = mode === 'manual' ? 'auto' : 'none';

            if (mode === 'manual') {
                restoreHint();
                allMeters.forEach(m => m.setValue(parseFloat(slider.value)));
            } else if (mode === 'sim') {
                hintEl.style.color = '#444';
                hintEl.textContent = 'Simulating audio signal across three channels.';
                simLevel = -12;
                simTimer = setInterval(simulateAudio, 42); // ~24 Hz
            } else if (mode === 'mic') {
                hintEl.style.color = '#444';
                hintEl.textContent = 'Requesting microphone access…';
                startMic();
            }
        }

        function restoreHint() {
            hintEl.style.color = '#444';
            hintEl.textContent = mode === 'manual'
                ? 'Drag the slider to set the level on all three meters.'
                : mode === 'sim'
                ? 'Simulating audio signal across three channels.'
                : 'Microphone active.';
        }

        btnManual.addEventListener('click', () => setMode('manual'));
        btnSim.addEventListener('click',    () => setMode(mode === 'sim' ? 'manual' : 'sim'));
        btnMic.addEventListener('click',    () => setMode(mode === 'mic' ? 'manual' : 'mic'));

        // ─── Simulated audio ─────────────────────────────────────────────────

        function simulateAudio() {
            // Random walk with drift toward simLevel
            simLevel += (Math.random() - 0.48) * 2.5;
            simLevel += (-9 - simLevel) * 0.04;  // drift toward -9 dB
            simLevel = Math.max(-20, Math.min(4, simLevel));

            // Each channel gets slight independent variation
            meterL.setValue(simLevel + (Math.random() - 0.5) * 2);
            meterR.setValue(simLevel + (Math.random() - 0.5) * 2);
            meterM.setValue(simLevel + (Math.random() - 0.5) * 0.8);
        }

        // ─── Microphone input ────────────────────────────────────────────────

        function startMic() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                hintEl.textContent = 'Microphone API not available in this browser.';
                setMode('manual');
                return;
            }

            navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                .then(function (stream) {
                    micStream = stream;
                    audioCtx  = new (window.AudioContext || window.webkitAudioContext)();
                    analyser  = audioCtx.createAnalyser();
                    analyser.fftSize = 256;

                    const source = audioCtx.createMediaStreamSource(stream);
                    source.connect(analyser);

                    hintEl.textContent = 'Microphone active. All three meters show the same input.';
                    pollMic();
                })
                .catch(function (err) {
                    hintEl.textContent = 'Microphone access denied: ' + err.message;
                    setMode('manual');
                });
        }

        function pollMic() {
            if (mode !== 'mic') return;

            const buf = new Float32Array(analyser.fftSize);
            analyser.getFloatTimeDomainData(buf);

            // RMS amplitude
            let sum = 0;
            for (let i = 0; i < buf.length; i++) sum += buf[i] * buf[i];
            const rms = Math.sqrt(sum / buf.length);

            allMeters.forEach(m => m.setAmplitude(rms));
            micRafId = requestAnimationFrame(pollMic);
        }

        function stopMic() {
            if (micRafId !== null) {
                cancelAnimationFrame(micRafId);
                micRafId = null;
            }
            if (micStream) {
                micStream.getTracks().forEach(t => t.stop());
                micStream = null;
            }
            if (audioCtx) {
                audioCtx.close();
                audioCtx = null;
                analyser = null;
            }
        }

    }());

    // ─── S-meter ─────────────────────────────────────────────────────────────
    (function () {
        const meterSm = new VUMeter(document.getElementById('meter-smeter'), {
            scalePreset:   'smeter',
            dbMin:         -121,
            dbMax:         -13,
            noiseFloor:    -121,
            clipThreshold: -53,
            showLight:     true,
            showPeak:      true,
            label:         'SIGNAL',
            brand:         '14.205 MHz',
        });

        const smSlider  = document.getElementById('sm-slider');
        const smReadout = document.getElementById('sm-readout');
        const smHint    = document.getElementById('sm-hint');
        const btnSmMan  = document.getElementById('btn-sm-manual');
        const btnSmSim  = document.getElementById('btn-sm-sim');

        let smMode  = 'manual';
        let smTimer = null;
        let smLevel = -100;

        smSlider.addEventListener('input', function () {
            smReadout.textContent = parseFloat(this.value).toFixed(1) + ' dBm';
            if (smMode === 'manual') meterSm.setValue(parseFloat(this.value));
        });

        function smSetMode(mode) {
            smMode = mode;
            btnSmMan.classList.toggle('active', mode === 'manual');
            btnSmSim.classList.toggle('active', mode === 'sim');

            if (smTimer) { clearInterval(smTimer); smTimer = null; }

            if (mode === 'manual') {
                smHint.textContent = 'Drag the slider to set the signal level. Clip threshold is S9+20 (−53 dBm).';
                meterSm.setValue(parseFloat(smSlider.value));
            } else {
                smHint.textContent = 'Simulating SDR signal with slow fading and occasional bursts.';
                smLevel = -100;
                smTimer = setInterval(function () {
                    // Slow random walk with occasional signal burst
                    smLevel += (Math.random() - 0.49) * 3;
                    smLevel += (-90 - smLevel) * 0.02;   // drift toward S5 area
                    if (Math.random() < 0.01) smLevel = -55 + Math.random() * 10; // burst
                    smLevel = Math.max(-121, Math.min(-13, smLevel));
                    smReadout.textContent = smLevel.toFixed(1) + ' dBm';
                    meterSm.setValue(smLevel);
                }, 50); // 20 Hz
            }
        }

        btnSmMan.addEventListener('click', () => smSetMode('manual'));
        btnSmSim.addEventListener('click', () => smSetMode(smMode === 'sim' ? 'manual' : 'sim'));
    }());
    </script>

</body>
</html>
